<!-- 
    PAINEL DE ALTA PERFORMANCE COM SISTEMA DE CADASTRO COMPLETO
    
    Novidades:
    1. Cadastro Completo: Agora solicita Nome, Telefone, Loja e Senha.
    2. Redirecionamento Inteligente: Alterna entre Login (simples) e Cadastro (completo) na mesma tela.
    3. Banco de Dados: Salva as informa√ß√µes extras do perfil do consultor.

    CONFIGURA√á√ÉO OBRIGAT√ìRIA:
    Substitua o objeto "firebaseConfig" abaixo pelas suas chaves do Firebase.
-->

<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Alta Performance: Consultor de √ìtica</title>
    
    <!-- Estilos e Gr√°ficos -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, doc, setDoc, getDoc } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        // --- √ÅREA DE CONFIGURA√á√ÉO ---
        // COLE SUAS CHAVES AQUI
        const firebaseConfig = {
  apiKey: "AIzaSyA2w-s3ZGRlUW3KJ12Qy6fqdUJYL7TpwcE",
  authDomain: "proximo-nivel-7bc9d.firebaseapp.com",
  projectId: "proximo-nivel-7bc9d",
  storageBucket: "proximo-nivel-7bc9d.firebasestorage.app",
  messagingSenderId: "108222503240",
  appId: "1:108222503240:web:31e62f4fafd58f8e7abb7d",
  measurementId: "G-KSQEND9KWH"
};


        // Inicializa√ß√£o
        let db, auth;
        
        try {
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            
            // Autentica√ß√£o an√¥nima para permitir conex√£o ao DB
            signInAnonymously(auth).then(() => console.log("Conectado ao Firebase."));

        } catch (e) {
            console.error("Erro Firebase:", e);
        }

        // --- L√ìGICA DE SEGURAN√áA (HASH) ---
        async function hashPassword(message) {
            const msgBuffer = new TextEncoder().encode(message);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // --- CONTROLE DE INTERFACE (LOGIN vs CADASTRO) ---
        window.isRegistering = false;
        
        window.toggleAuthMode = function() {
            window.isRegistering = !window.isRegistering;
            const title = document.getElementById('auth-title');
            const btn = document.getElementById('auth-submit-btn');
            const toggleText = document.getElementById('auth-toggle-text');
            const extraFields = document.getElementById('register-extra-fields');

            if (window.isRegistering) {
                // MODO CADASTRO
                title.innerText = "Novo Cadastro";
                btn.innerText = "Criar Minha Conta";
                toggleText.innerHTML = 'J√° tem conta? <button type="button" onclick="toggleAuthMode()" class="text-teal-600 font-bold hover:underline">Fazer Login</button>';
                document.getElementById('login-name').placeholder = "Crie um nome de usu√°rio";
                
                // Mostrar campos extras
                extraFields.classList.remove('hidden');
            } else {
                // MODO LOGIN
                title.innerText = "Login do Consultor";
                btn.innerText = "Entrar";
                toggleText.innerHTML = 'Primeira vez aqui? <button type="button" onclick="toggleAuthMode()" class="text-teal-600 font-bold hover:underline">Cadastre-se</button>';
                document.getElementById('login-name').placeholder = "Seu nome de usu√°rio";
                
                // Esconder campos extras
                extraFields.classList.add('hidden');
            }
        };

        // --- FUN√á√ÉO PRINCIPAL DE AUTH ---
        window.handleAuthSubmit = async function(e) {
            e.preventDefault();
            if (!db) { alert("Erro: Firebase n√£o configurado. Verifique o c√≥digo."); return; }

            const nameInput = document.getElementById('login-name').value.trim();
            const passInput = document.getElementById('login-pass').value.trim();
            const btn = document.getElementById('auth-submit-btn');
            const originalText = btn.innerText;

            if (!nameInput || !passInput) {
                alert("Preencha o Usu√°rio e a Senha.");
                return;
            }
            if (passInput.length < 4) {
                alert("A senha precisa ter pelo menos 4 caracteres.");
                return;
            }

            // Valida√ß√£o de campos extras no cadastro
            let phoneInput = "";
            let storeInput = "";
            if (window.isRegistering) {
                phoneInput = document.getElementById('register-phone').value.trim();
                storeInput = document.getElementById('register-store').value.trim();

                if (!phoneInput || !storeInput) {
                    alert("Por favor, preencha o Telefone e o Nome da Loja.");
                    return;
                }
            }

            btn.innerText = "Processando...";
            btn.disabled = true;

            try {
                // Cria ID seguro (ex: Jo√£o Silva -> joao_silva)
                const safeId = nameInput.replace(/[^a-zA-Z0-9]/g, '_').toLowerCase();
                const userDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', safeId);
                const passwordHash = await hashPassword(passInput);

                if (window.isRegistering) {
                    // --- MODO CADASTRO ---
                    const docSnap = await getDoc(userDocRef);
                    if (docSnap.exists()) {
                        alert("Este nome de usu√°rio j√° existe. Por favor, escolha outro.");
                        btn.innerText = originalText;
                        btn.disabled = false;
                        return;
                    }

                    // Cria o usu√°rio com todos os dados
                    await setDoc(userDocRef, {
                        name: nameInput,
                        phone: phoneInput,
                        store: storeInput,
                        passwordHash: passwordHash,
                        createdAt: new Date().toISOString()
                    });

                    alert("Conta criada com sucesso!");
                    loginSuccess(nameInput, storeInput);

                } else {
                    // --- MODO LOGIN ---
                    const docSnap = await getDoc(userDocRef);
                    
                    if (!docSnap.exists()) {
                        alert("Usu√°rio n√£o encontrado. Clique em 'Cadastre-se' para criar uma conta.");
                        btn.innerText = originalText;
                        btn.disabled = false;
                        return;
                    }

                    const userData = docSnap.data();
                    if (userData.passwordHash !== passwordHash) {
                        alert("Senha incorreta.");
                        btn.innerText = originalText;
                        btn.disabled = false;
                        return;
                    }

                    loginSuccess(userData.name, userData.store || "Minha Loja");
                }

            } catch (err) {
                console.error(err);
                alert("Erro de conex√£o: " + err.message);
                btn.innerText = originalText;
                btn.disabled = false;
            }
        };

        // Sucesso no Login
        function loginSuccess(name, storeName) {
            window.consultantName = name;
            localStorage.setItem('optical_consultant_name', name);
            
            document.getElementById('login-view').classList.add('hidden');
            document.getElementById('dashboard-view').classList.remove('hidden');
            document.getElementById('header-consultant-name').innerText = name;
            
            // Opcional: Mostrar nome da loja em algum lugar se desejar
            console.log("Logado na loja:", storeName);
            
            window.loadDayData(window.currentDayIndex);
        }

        // --- FUN√á√ïES DE DADOS (DASHBOARD) ---
        window.consultantName = localStorage.getItem('optical_consultant_name') || '';

        window.getDateKey = function(dayIndex) {
            const today = new Date();
            const dayDiff = dayIndex - (today.getDay() === 0 ? 6 : today.getDay() - 1);
            const targetDate = new Date(today);
            targetDate.setDate(today.getDate() + dayDiff);
            return targetDate.toISOString().split('T')[0];
        }

        window.saveToDb = async function(dataObj) {
            if (!db || !window.consultantName) return;

            const dateKey = window.getDateKey(window.currentDayIndex);
            const safeName = window.consultantName.replace(/[^a-zA-Z0-9]/g, '_').toLowerCase();
            const docId = `${safeName}_${dateKey}`;
            
            // Salva na cole√ß√£o 'daily_reports'
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'daily_reports', docId);

            try {
                const statusEl = document.getElementById('save-status');
                if(statusEl) statusEl.innerText = "Salvando...";
                
                await setDoc(docRef, dataObj, { merge: true });
                
                if(statusEl) {
                    statusEl.innerText = "Salvo ‚úì";
                    setTimeout(() => { statusEl.innerText = ""; }, 2000);
                }
            } catch (e) {
                console.error("Erro ao salvar:", e);
            }
        };

        window.fetchFromDb = async function(dayIndex) {
            if (!db || !window.consultantName) return null;

            const dateKey = window.getDateKey(dayIndex);
            const safeName = window.consultantName.replace(/[^a-zA-Z0-9]/g, '_').toLowerCase();
            const docId = `${safeName}_${dateKey}`;
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'daily_reports', docId);

            try {
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    return docSnap.data();
                }
            } catch (e) { console.error(e); }
            return null;
        };
        
        // Auto-preenchimento
        document.addEventListener("DOMContentLoaded", () => {
             const storedName = localStorage.getItem('optical_consultant_name');
             if(storedName) document.getElementById('login-name').value = storedName;
        });

    </script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #fdfbf7; color: #2d3748; }
        .timeline-line { position: absolute; left: 1.25rem; top: 0; bottom: 0; width: 2px; background-color: #e2e8f0; z-index: 0; }
        .checkbox-custom { appearance: none; width: 1.2em; height: 1.2em; border: 2px solid #38b2ac; border-radius: 4px; display: inline-grid; place-content: center; cursor: pointer; }
        .checkbox-custom::before { content: ""; width: 0.65em; height: 0.65em; transform: scale(0); transition: 120ms transform ease-in-out; box-shadow: inset 1em 1em #38b2ac; transform-origin: center; clip-path: polygon(14% 44%, 0 65%, 50% 100%, 100% 16%, 80% 0%, 43% 62%); }
        .checkbox-custom:checked::before { transform: scale(1); }
        .chart-container { position: relative; width: 100%; max-width: 100%; height: 250px; }
        .login-bg { background-image: radial-gradient(#38b2ac 0.5px, #fdfbf7 0.5px); background-size: 10px 10px; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- TELA DE LOGIN / CADASTRO -->
    <div id="login-view" class="fixed inset-0 z-50 flex items-center justify-center login-bg px-4 overflow-y-auto">
        <div class="bg-white p-8 rounded-xl shadow-xl max-w-md w-full border border-gray-100 transition-all duration-300 my-8">
            <div class="text-center mb-6">
                <span class="text-4xl mb-2 block">üëì</span>
                <h1 id="auth-title" class="text-2xl font-bold text-gray-800">Login do Consultor</h1>
                <p class="text-sm text-gray-500">Acesse seu painel de performance</p>
            </div>
            
            <form onsubmit="handleAuthSubmit(event)" class="space-y-4">
                <!-- Campos Padr√£o -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nome de Usu√°rio</label>
                    <input type="text" id="login-name" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-teal-500 focus:border-teal-500 outline-none transition-all" placeholder="Seu nome de usu√°rio" required>
                </div>
                
                <!-- Campos Extras de Cadastro (Ocultos inicialmente) -->
                <div id="register-extra-fields" class="hidden space-y-4 border-l-2 border-teal-100 pl-4 py-1">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Telefone / WhatsApp</label>
                        <input type="tel" id="register-phone" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-teal-500 focus:border-teal-500 outline-none transition-all" placeholder="(00) 00000-0000">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nome da Loja</label>
                        <input type="text" id="register-store" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-teal-500 focus:border-teal-500 outline-none transition-all" placeholder="Ex: √ìtica Vis√£o Centro">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Senha</label>
                    <input type="password" id="login-pass" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-teal-500 focus:border-teal-500 outline-none transition-all" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                </div>

                <button type="submit" id="auth-submit-btn" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition-colors duration-200">
                    Entrar
                </button>
            </form>
            
            <div class="mt-6 text-center text-sm text-gray-600">
                <p id="auth-toggle-text">
                    Primeira vez aqui? 
                    <button type="button" onclick="toggleAuthMode()" class="text-teal-600 font-bold hover:underline">Cadastre-se</button>
                </p>
            </div>
        </div>
    </div>

    <!-- TELA DO PAINEL (Oculta inicialmente) -->
    <div id="dashboard-view" class="hidden flex flex-col min-h-screen w-full">
        
        <!-- Cabe√ßalho -->
        <header class="bg-white border-b border-gray-200 sticky top-0 z-40 shadow-sm">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3">
                <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                    <div class="flex items-center gap-3">
                        <div class="h-10 w-10 bg-teal-100 rounded-full flex items-center justify-center text-teal-700 font-bold">
                            <span id="user-initials">CP</span>
                        </div>
                        <div>
                            <h1 class="text-lg font-bold text-gray-800 tracking-tight leading-tight">Ol√°, <span id="header-consultant-name">Consultor</span></h1>
                            <div class="flex items-center gap-2">
                                <p class="text-xs text-gray-500">Painel Di√°rio</p>
                                <span id="save-status" class="text-xs font-bold text-green-600 animate-pulse"></span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Seletor de Dia -->
                    <div class="flex bg-gray-100 p-1 rounded-lg overflow-x-auto w-full md:w-auto">
                        <button onclick="setDay(0)" class="day-btn flex-1 px-4 py-2 rounded-md text-sm font-medium transition-colors focus:outline-none hover:bg-white hover:shadow-sm" data-day="0">Seg</button>
                        <button onclick="setDay(1)" class="day-btn flex-1 px-4 py-2 rounded-md text-sm font-medium transition-colors focus:outline-none hover:bg-white hover:shadow-sm" data-day="1">Ter</button>
                        <button onclick="setDay(2)" class="day-btn flex-1 px-4 py-2 rounded-md text-sm font-medium transition-colors focus:outline-none hover:bg-white hover:shadow-sm" data-day="2">Qua</button>
                        <button onclick="setDay(3)" class="day-btn flex-1 px-4 py-2 rounded-md text-sm font-medium transition-colors focus:outline-none hover:bg-white hover:shadow-sm" data-day="3">Qui</button>
                        <button onclick="setDay(4)" class="day-btn flex-1 px-4 py-2 rounded-md text-sm font-medium transition-colors focus:outline-none hover:bg-white hover:shadow-sm" data-day="4">Sex</button>
                        <button onclick="setDay(5)" class="day-btn flex-1 px-4 py-2 rounded-md text-sm font-medium transition-colors focus:outline-none hover:bg-white hover:shadow-sm" data-day="5">S√°b</button>
                    </div>
                </div>
            </div>
        </header>

        <main class="flex-grow max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 w-full grid grid-cols-1 lg:grid-cols-12 gap-8">
            
            <!-- Barra Lateral Esquerda: Linha do Tempo -->
            <div class="lg:col-span-7 flex flex-col gap-6">
                <div class="flex justify-between items-end border-b pb-2 mb-2">
                    <h3 class="text-xl font-bold text-gray-800">Rotina Di√°ria</h3>
                    <span class="text-xs font-semibold text-orange-600 bg-orange-100 px-2 py-1 rounded">Prioridade: Cliente na Loja</span>
                </div>

                <div class="relative pl-4" id="timeline-container">
                    <!-- Preenchido via JavaScript -->
                </div>
            </div>

            <!-- Coluna Direita: Ferramentas -->
            <div class="lg:col-span-5 flex flex-col gap-6">
                
                <!-- Card da Miss√£o do Dia -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 transition-all duration-300 hover:shadow-md">
                    <div class="flex items-center gap-3 mb-4">
                        <span class="text-2xl">üéØ</span>
                        <div>
                            <h3 class="text-lg font-bold text-gray-800">Miss√£o do Dia</h3>
                            <p id="mission-day-label" class="text-xs text-gray-500 uppercase tracking-wide font-bold">Carregando...</p>
                        </div>
                    </div>
                    <div class="space-y-3">
                        <div class="p-3 bg-blue-50 rounded-lg border border-blue-100">
                            <span class="text-xs font-bold text-blue-600 uppercase">Foco Principal</span>
                            <p id="mission-focus" class="text-gray-800 font-medium mt-1">...</p>
                        </div>
                        <div class="p-3 bg-purple-50 rounded-lg border border-purple-100">
                            <span class="text-xs font-bold text-purple-600 uppercase">A√ß√£o Extra</span>
                            <p id="mission-action" class="text-gray-700 text-sm mt-1">...</p>
                        </div>
                    </div>
                </div>

                <!-- Scripts R√°pidos -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <h3 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2">üó£Ô∏è Scripts R√°pidos</h3>
                    <div class="space-y-2">
                        <div class="border rounded-lg overflow-hidden">
                            <button class="w-full px-4 py-3 text-left bg-gray-50 hover:bg-gray-100 flex justify-between items-center text-sm font-medium text-gray-700" onclick="toggleScript('script-1')">
                                üìû Resgate (1 ano+) <span class="text-gray-400 text-xs">‚ñº</span>
                            </button>
                            <div id="script-1" class="hidden px-4 py-3 bg-white text-sm text-gray-600 border-t border-gray-100 italic">
                                "Ol√° [Nome], vi que faz um ano dos seus √≥culos. Como est√° a adapta√ß√£o? Estamos com a agenda aberta para uma revis√£o gratuita..."
                            </div>
                        </div>
                        <div class="border rounded-lg overflow-hidden">
                            <button class="w-full px-4 py-3 text-left bg-gray-50 hover:bg-gray-100 flex justify-between items-center text-sm font-medium text-gray-700" onclick="toggleScript('script-2')">
                                ‚úÖ P√≥s-Venda (7/15 dias) <span class="text-gray-400 text-xs">‚ñº</span>
                            </button>
                            <div id="script-2" class="hidden px-4 py-3 bg-white text-sm text-gray-600 border-t border-gray-100 italic">
                                "Os √≥culos est√£o confort√°veis? A vis√£o est√° n√≠tida? Precisa de algum ajuste?"
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Gr√°fico e Inputs -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <h3 class="text-lg font-bold text-gray-800 mb-2">üìä Relat√≥rio</h3>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-xs font-semibold text-gray-600 mb-1">Vendas (R$)</label>
                            <input type="number" id="input-sales" class="w-full p-2 border border-gray-300 rounded text-sm outline-none" placeholder="0" oninput="handleMetricChange()">
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-gray-600 mb-1">Meta (R$)</label>
                            <input type="number" id="input-goal" class="w-full p-2 border border-gray-300 rounded text-sm outline-none" value="2000" oninput="handleMetricChange()">
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-gray-600 mb-1">Leads</label>
                            <input type="number" id="input-leads" class="w-full p-2 border border-gray-300 rounded text-sm outline-none" placeholder="0" oninput="handleMetricChange()">
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-gray-600 mb-1">Agendamentos</label>
                            <input type="number" id="input-appointments" class="w-full p-2 border border-gray-300 rounded text-sm outline-none" placeholder="0" oninput="handleMetricChange()">
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="performanceChart"></canvas>
                    </div>
                </div>

            </div>
        </main>
        
        <footer class="bg-white border-t border-gray-200 mt-auto">
            <div class="max-w-7xl mx-auto px-4 py-6 text-center text-sm text-gray-500">
                <button onclick="logout()" class="text-teal-600 underline">Sair / Trocar Usu√°rio</button>
            </div>
        </footer>
    </div>

    <!-- L√ìGICA DA INTERFACE -->
    <script>
        // --- DADOS DO CRONOGRAMA ---
        const scheduleData = [
            { time: "08:00 - 09:00", title: "Prepara√ß√£o", icon: "üßπ", desc: "Organiza√ß√£o da loja.", tasks: ["Limpeza vitrines", "Confer√™ncia OS", "Definir Meta"] },
            { time: "09:00 - 10:00", title: "Tr√°fego Digital", icon: "üì±", desc: "Gerar desejo.", tasks: ["Stories (V√≠deo)", "Stories (Enquete)", "Responder Directs"] },
            { time: "10:00 - 11:30", title: "CRM e Base", icon: "üìû", desc: "Foco no retorno.", tasks: ["Ligar Clientes (1 ano)", "Aniversariantes", "Or√ßamentos pendentes"] },
            { time: "11:30 - 13:30", title: "Almo√ßo", icon: "üçΩÔ∏è", desc: "Descanso.", tasks: [], isBreak: true },
            { time: "13:30 - 15:00", title: "A√ß√µes Externas", icon: "ü§ù", desc: "Buscar novos leads.", tasks: ["Visitar vizinhos", "Entregar cart√µes", "Coletar 5 contatos"] },
            { time: "15:00 - 17:00", title: "Vendas e P√≥s", icon: "üõçÔ∏è", desc: "Foco no sal√£o.", tasks: ["Atendimento", "P√≥s-Venda (7 dias)", "Repor vitrine"] },
            { time: "17:00 - 18:00", title: "Fechamento", icon: "üìù", desc: "Organizar amanh√£.", tasks: ["Responder leads tarde", "Relat√≥rio", "Fechar caixa"] }
        ];

        const weeklyMissions = [
            { day: "Segunda-feira", focus: "CRM Intenso", action: "Resgatar clientes de s√°bado.", digital: "Motivacional" },
            { day: "Ter√ßa-feira", focus: "Prospec√ß√£o Externa", action: "Visitar empresas.", digital: "V√≠deo t√©cnico" },
            { day: "Quarta-feira", focus: "Vitrine", action: "Organizar Lentes.", digital: "Lentes de Contato" },
            { day: "Quinta-feira", focus: "Ofertas", action: "Resgatar or√ßamentos antigos.", digital: "#TBT" },
            { day: "Sexta-feira", focus: "Fechamento", action: "Confirmar agenda s√°bado.", digital: "Fim de semana" },
            { day: "S√°bado", focus: "Vendas", action: "Criar movimento na loja.", digital: "Bastidores" },
        ];

        window.currentDayIndex = 0;

        // Renderiza√ß√£o Inicial
        document.addEventListener('DOMContentLoaded', () => {
            renderTimeline();
            initChart();
        });

        // Fun√ß√µes de UI
        function renderTimeline() {
            const container = document.getElementById('timeline-container');
            container.innerHTML = '<div class="timeline-line"></div>';

            scheduleData.forEach((block, index) => {
                const isBreak = block.isBreak ? 'opacity-75 bg-gray-100' : 'bg-white';
                const html = `
                    <div class="relative z-10 mb-6 pl-8">
                        <div class="absolute left-0 -translate-x-1/2 w-10 h-10 bg-white border-4 border-gray-200 rounded-full flex items-center justify-center text-lg shadow-sm" style="margin-left: 2px;">
                            ${block.icon}
                        </div>
                        <div class="${isBreak} rounded-lg shadow-sm border border-gray-200 cursor-pointer group" onclick="toggleBlock(${index})">
                            <div class="p-4 flex justify-between items-center">
                                <div>
                                    <span class="text-xs font-bold text-teal-600 uppercase">${block.time}</span>
                                    <h4 class="text-md font-bold text-gray-800">${block.title}</h4>
                                </div>
                                <span class="text-gray-400 group-hover:text-teal-600">‚ñº</span>
                            </div>
                            ${block.tasks.length > 0 ? `
                            <div id="block-content-${index}" class="hidden px-4 pb-4 pt-0 border-t border-gray-100 mt-2">
                                <ul class="space-y-2 mt-2">
                                    ${block.tasks.map((task, taskIdx) => `
                                        <li class="flex items-start gap-3">
                                            <input type="checkbox" id="task-${index}-${taskIdx}" class="checkbox-custom mt-1 flex-shrink-0" onclick="handleTaskClick(event)">
                                            <span class="text-sm text-gray-700">${task}</span>
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>` : ''}
                        </div>
                    </div>`;
                container.insertAdjacentHTML('beforeend', html);
            });
        }

        window.toggleBlock = (i) => document.getElementById(`block-content-${i}`)?.classList.toggle('hidden');
        window.toggleScript = (id) => document.getElementById(id)?.classList.toggle('hidden');
        window.logout = () => { localStorage.removeItem('optical_consultant_name'); location.reload(); };

        window.setDay = async function(dayIndex) {
            window.currentDayIndex = dayIndex;
            // Atualiza bot√µes
            document.querySelectorAll('.day-btn').forEach(btn => {
                const active = parseInt(btn.dataset.day) === dayIndex;
                btn.className = `day-btn flex-1 px-4 py-2 rounded-md text-sm font-medium transition-colors focus:outline-none hover:shadow-sm ${active ? 'bg-teal-600 text-white shadow-md' : 'text-gray-600 hover:bg-white'}`;
            });
            
            // Atualiza Miss√£o
            const m = weeklyMissions[dayIndex];
            document.getElementById('mission-day-label').innerText = m.day;
            document.getElementById('mission-focus').innerText = m.focus;
            document.getElementById('mission-action').innerText = m.action;
            
            await window.loadDayData(dayIndex);
        };

        // Carregamento de Dados
        window.loadDayData = async function(dayIndex) {
            // Limpa campos visualmente
            document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
            ['input-sales', 'input-leads', 'input-appointments'].forEach(id => document.getElementById(id).value = '');
            document.getElementById('input-goal').value = 2000;
            updateChart();

            // Busca no DB
            const data = await window.fetchFromDb(dayIndex);
            if (data) {
                if(data.sales) document.getElementById('input-sales').value = data.sales;
                if(data.goal) document.getElementById('input-goal').value = data.goal;
                if(data.leads) document.getElementById('input-leads').value = data.leads;
                if(data.appointments) document.getElementById('input-appointments').value = data.appointments;
                if(data.tasks) {
                    Object.keys(data.tasks).forEach(key => {
                        const cb = document.getElementById(`task-${key}`);
                        if(cb) cb.checked = data.tasks[key];
                    });
                }
                updateChart();
            }
        };

        // Salvar Checkbox
        window.handleTaskClick = function(e) {
            e.stopPropagation();
            const allTasks = {};
            document.querySelectorAll('.checkbox-custom').forEach(cb => {
                const idParts = cb.id.replace('task-', '');
                allTasks[idParts] = cb.checked;
            });
            window.saveToDb({ tasks: allTasks });
        };

        // Salvar M√©tricas com Debounce
        let saveTimeout;
        window.handleMetricChange = function() {
            updateChart();
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => {
                window.saveToDb({
                    sales: document.getElementById('input-sales').value,
                    goal: document.getElementById('input-goal').value,
                    leads: document.getElementById('input-leads').value,
                    appointments: document.getElementById('input-appointments').value
                });
            }, 1000);
        };

        // Gr√°fico
        let performanceChart;
        function initChart() {
            const ctx = document.getElementById('performanceChart').getContext('2d');
            performanceChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Realizado', 'Meta'],
                    datasets: [{
                        label: 'R$',
                        data: [0, 2000],
                        backgroundColor: ['rgba(56, 178, 172, 0.8)', 'rgba(203, 213, 224, 0.5)'],
                        borderColor: ['rgb(56, 178, 172)', 'rgb(203, 213, 224)'],
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, grid: { color: '#f7fafc' } }, x: { grid: { display: false } } }
                }
            });
        }
        function updateChart() {
            const sales = parseFloat(document.getElementById('input-sales').value) || 0;
            const goal = parseFloat(document.getElementById('input-goal').value) || 2000;
            performanceChart.data.datasets[0].data = [sales, goal];
            performanceChart.data.datasets[0].backgroundColor[0] = sales >= goal ? 'rgba(72, 187, 120, 0.9)' : 'rgba(56, 178, 172, 0.8)';
            performanceChart.update();
        }
    </script>
</body>
</html>
